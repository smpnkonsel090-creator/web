<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QR Scanner Absensi Siswa</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
header { background:#007bff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; color:white; }
header .left { display:flex; align-items:center; gap:10px; }
header img { width:40px; height:40px; object-fit:contain; }
header h1 { font-size:20px; margin:0; }
#btnSimpan { background:white; color:#007bff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; font-weight:bold; }
#container { display:flex; gap:20px; padding:20px; flex-wrap:wrap; justify-content:center; align-items:flex-start; }
#qr-reader { width:400px; height:400px; border:2px solid #007bff; border-radius:10px; background:#000; flex-shrink:0; display:flex; justify-content:center; align-items:center; }
#filter-wrapper, #search-wrapper { margin-top:10px; text-align:center; }
#filter-wrapper select, #searchInput { padding:8px; border-radius:5px; border:1px solid #007bff; }
#searchInput { width:90%; max-width:300px; }
#absensi-wrapper { flex:1 1 700px; background:white; border-radius:10px; overflow-y:auto; max-height:480px; border:2px solid #007bff; }
#absensi-table { width:100%; border-collapse:collapse; }
#absensi-table th, #absensi-table td { border:1px solid #ccc; padding:8px; }
#absensi-table th { background-color:#007bff; color:white; position:sticky; top:0; z-index:1; text-align:center; }
#absensi-table td { text-align:left; }
#absensi-table td:nth-child(1), #absensi-table td:nth-child(3),
#absensi-table td:nth-child(4), #absensi-table td:nth-child(5),
#absensi-table td:nth-child(6), #absensi-table td:nth-child(7) { text-align:center; }
#absensi-table td:nth-child(2) { text-align:left; font-weight:bold; }
.toast { padding:10px 20px; background-color:#333; color:white; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); border-radius:5px; opacity:0.9; z-index:9999; }
/* Responsif */
@media(max-width:1000px){
    #container { flex-direction:column; align-items:center; }
    #qr-reader { width:90%; height:auto; max-width:400px; margin-bottom:20px; }
    #absensi-wrapper { width:90%; max-width:800px; }
}
</style>
</head>
<body>

<header>
  <div class="left">
    <img src="logo.png" alt="Logo SMPN 20">
    <h1>ABSENSI SISWA</h1>
  </div>
  <button id="btnSimpan">Simpan</button>
</header>

<div id="container">
  <div>
    <div id="qr-reader"></div>

    <!-- Filter kelas -->
    <div id="filter-wrapper">
      <label for="filterKelas">Filter Kelas: </label>
      <select id="filterKelas">
        <option value="ALL">Semua</option>
      </select>
    </div>

    <!-- Pencarian nama/NIS -->
    <div id="search-wrapper">
      <input type="text" id="searchInput" placeholder="Cari nama / NIS...">
    </div>
  </div>

  <div id="absensi-wrapper">
    <table id="absensi-table">
      <thead>
        <tr>
          <th>NIS</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Jam Datang</th>
          <th>Jam Pulang</th>
          <th>Status</th>
          <th>Keterangan</th>
        </tr>
      </thead>
      <tbody id="absensi-body"></tbody>
    </table>
  </div>
</div>

<audio id="beep-sound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

<script>
// --- Firebase config sama dengan punyamu ---
const firebaseConfig = {
  apiKey: "AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain: "absensi-smpn-20-konsel.firebaseapp.com",
  projectId: "absensi-smpn-20-konsel",
  storageBucket: "absensi-smpn-20-konsel.appspot.com",
  messagingSenderId: "247838919432",
  appId: "1:247838919432:web:4505c7d499fb5d716dfabd",
  measurementId: "G-1TNJRBYFEV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let tanggalLiburList=[], sudahPrefill=false;
const debounceMap={}, debounceMillis=3000;
const absensiBody=document.getElementById("absensi-body");
const beep=document.getElementById("beep-sound");
const filterSelect=document.getElementById("filterKelas");
const searchInput=document.getElementById("searchInput");

// âœ… fungsi toast, getToday, isDalamRentang sama dengan punyamu...

// --- di updateAbsensiTableRealtime tambahkan pencarian ---
function updateAbsensiTableRealtime(today){
  db.collection("absensi").doc(today).onSnapshot(doc=>{
    const data=doc.data()||{};
    const siswaArr=Object.values(data).map(s=>{
      const lastAbsenTime=s.jamPulang?s.jamPulang.seconds:(s.jamDatang?s.jamDatang.seconds:0);
      return {...s,lastAbsenTime};
    }).sort((a,b)=>b.lastAbsenTime-a.lastAbsenTime);

    const filterKelas=filterSelect.value;
    const query=searchInput.value.toLowerCase();

    absensiBody.innerHTML="";
    siswaArr.forEach(siswa=>{
      if(filterKelas!=="ALL"&&siswa.kelas!==filterKelas) return;
      if(query && !(siswa.nama.toLowerCase().includes(query)||siswa.nis.toLowerCase().includes(query))) return;

      const jamDatang=siswa.jamDatang?new Date(siswa.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):'';
      const jamPulang=siswa.jamPulang?new Date(siswa.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):'';
      const row=document.createElement("tr");
      row.innerHTML=`<td>${siswa.nis}</td><td>${siswa.nama}</td><td>${siswa.kelas}</td><td>${jamDatang}</td><td>${jamPulang}</td><td>${siswa.status}</td><td>${siswa.keterangan}</td>`;
      absensiBody.appendChild(row);
    });
  });
}

// ðŸ”¹ event untuk pencarian & filter
filterSelect.addEventListener("change",()=>updateAbsensiTableRealtime(getToday()));
searchInput.addEventListener("input",()=>updateAbsensiTableRealtime(getToday()));

// --- sisanya (prefillAbsensiHariIni, updateStatusAbsensi, onScanSuccess, mulaiScan) tetap sama ---
</script>
</body>
</html>
