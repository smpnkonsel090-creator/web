<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>QR Scanner Absensi Siswa</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- QR Scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#007bff;color:#fff;padding:15px;text-align:center}
#container{display:flex;gap:20px;padding:20px;flex-wrap:wrap;justify-content:center}
#qr-reader{width:400px;height:400px;border:2px solid #007bff;border-radius:10px;background:#000}

#panel{
  margin-top:10px;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.1)
}
#panel label{display:flex;gap:8px;margin:6px 0}

#absensi-wrapper{
  flex:1 1 700px;
  background:#fff;
  border-radius:10px;
  max-height:480px;
  overflow:auto;
  border:2px solid #007bff
}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px}
th{background:#007bff;color:#fff;position:sticky;top:0}
td:nth-child(2){font-weight:bold;text-align:left}

tr.hadir{background:#d4edda}
tr.terlambat{background:#fff3cd}
tr.tidak-hadir{background:#f8d7da}
tr.scan-baru{outline:3px solid #28a745;animation:pop .3s}

@keyframes pop{from{transform:scale(.97)}to{transform:scale(1)}}

.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:10px 20px;
  border-radius:5px;
  z-index:9999
}
</style>
</head>

<body>

<header>
<h1>ABSENSI SISWA</h1>
<h3>SMPN 20 Konawe Selatan</h3>
</header>

<div id="container">
<div>
  <div id="qr-reader"></div>

  <!-- PANEL SOUND -->
  <div id="panel">
    <label><input type="checkbox" id="toggleSound" checked> ðŸ”Š Sound</label>
    <label><input type="checkbox" id="toggleVibrate" checked> ðŸ“³ Vibrasi</label>
  </div>
</div>

<div id="absensi-wrapper">
<table>
<thead>
<tr>
<th>NIS</th><th>Nama</th><th>Kelas</th>
<th>Datang</th><th>Pulang</th><th>Status</th><th>Keterangan</th>
</tr>
</thead>
<tbody id="absensi-body"></tbody>
</table>
</div>
</div>

<!-- SOUND -->
<audio id="sound-datang" src="datang.mp3" preload="auto"></audio>
<audio id="sound-pulang" src="pulang.mp3" preload="auto"></audio>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain:"absensi-smpn-20-konsel.firebaseapp.com",
  projectId:"absensi-smpn-20-konsel"
});
const db=firebase.firestore();

/* ================= SETTING ================= */
let jamDatangMulai=6, jamDatangAkhir=9;
let jamPulangMulai=11, jamPulangAkhir=13;
let toleransiMenit=3;
let tanggalLiburList=[];

const silentSchedule=[
  {start:"12:30",end:"13:30"},
  {start:"18:00",end:"23:59"}
];

const debounceMap={}, debounceMillis=3000;

/* ================= ELEMENT ================= */
const bodyEl=document.getElementById("absensi-body");
const toggleSound=document.getElementById("toggleSound");
const toggleVibrate=document.getElementById("toggleVibrate");

const soundDatang=document.getElementById("sound-datang");
const soundPulang=document.getElementById("sound-pulang");
soundDatang.volume=0.3;
soundPulang.volume=0.3;

/* ================= UTIL ================= */
function toast(msg){
  const t=document.createElement("div");
  t.className="toast";
  t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function today(){
  return new Date().toISOString().split("T")[0];
}

function silentNow(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  return silentSchedule.some(s=>{
    const [sh,sm]=s.start.split(":").map(Number);
    const [eh,em]=s.end.split(":").map(Number);
    return m>=sh*60+sm && m<=eh*60+em;
  });
}

function playSound(type){
  if(!toggleSound.checked || silentNow()) return;
  const s=type==="datang"?soundDatang:soundPulang;
  s.pause(); s.currentTime=0;
  s.play().catch(()=>{});
}

function vibrate(){
  if(!toggleVibrate.checked || silentNow()) return;
  if(navigator.vibrate) navigator.vibrate([120,80,120]);
}

/* ================= RENDER ================= */
function render(data){
  bodyEl.innerHTML="";
  Object.values(data).forEach(s=>{
    const tr=document.createElement("tr");

    if(s.status==="Hadir") tr.classList.add("hadir");
    else if(s.keterangan==="Terlambat") tr.classList.add("terlambat");
    else tr.classList.add("tidak-hadir");

    tr.innerHTML=`
      <td>${s.nis}</td>
      <td>${s.nama}</td>
      <td>${s.kelas}</td>
      <td>${s.jamDatang?.toDate?.().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})||""}</td>
      <td>${s.jamPulang?.toDate?.().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})||""}</td>
      <td>${s.status||""}</td>
      <td>${s.keterangan||""}</td>
    `;
    bodyEl.appendChild(tr);
  });
}

/* ================= ABSENSI ================= */
function updateStatusAbsensi(nis){
  const ref=db.collection("absensi").doc(today());
  ref.get().then(d=>{
    if(!d.exists||!d.data()[nis]){toast("Data tidak ditemukan");return}
    const s=d.data()[nis];
    const now=new Date();
    const h=now.getHours(), m=now.getMinutes();

    if(s.jamDatang&&s.jamPulang){toast("Sudah lengkap");return}

    if(!s.jamDatang && h>=jamDatangMulai && h<=jamDatangAkhir+toleransiMenit){
      ref.update({
        [`${nis}.jamDatang`]:firebase.firestore.FieldValue.serverTimestamp(),
        [`${nis}.status`]:"TK",
        [`${nis}.keterangan`]:"Datang"
      });
      playSound("datang"); vibrate(); toast("Absen datang");
    }
    else if(!s.jamPulang && h>=jamPulangMulai && h<=jamPulangAkhir+toleransiMenit){
      ref.update({
        [`${nis}.jamPulang`]:firebase.firestore.FieldValue.serverTimestamp(),
        [`${nis}.status`]:"Hadir",
        [`${nis}.keterangan`]:"Pulang"
      });
      playSound("pulang"); vibrate(); toast("Absen pulang");
    }
  });
}

/* ================= QR ================= */
new Html5Qrcode("qr-reader").start(
  {facingMode:"environment"},
  {fps:10,qrbox:280},
  msg=>{
    if(debounceMap[msg] && Date.now()-debounceMap[msg]<debounceMillis) return;
    debounceMap[msg]=Date.now();
    updateStatusAbsensi(msg.trim());
  }
);

/* ================= REALTIME ================= */
db.collection("absensi").doc(today())
.onSnapshot(d=>{ if(d.exists) render(d.data()) });

</script>
</body>
</html>
