<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QR Scanner Absensi Siswa</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }

/* HEADER */
header {
  background:#007bff;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
  padding:15px;
}
header img { width:80px; height:80px; }
header h1 { margin:0; font-size:26px; }
header h3 { margin:0; font-size:16px; font-weight:normal; }

/* LAYOUT */
#container {
  display:flex;
  gap:20px;
  padding:20px;
  flex-wrap:wrap;
  justify-content:center;
}
#qr-reader {
  width:400px;
  height:400px;
  border:2px solid #007bff;
  border-radius:10px;
  background:#000;
}
#filter-search {
  margin-top:10px;
  display:flex;
  gap:10px;
  justify-content:center;
}
#filter-search select,
#filter-search input {
  padding:8px;
  border-radius:5px;
  border:1px solid #ccc;
}

/* TABLE */
#absensi-wrapper {
  flex:1 1 700px;
  background:#fff;
  border-radius:10px;
  border:2px solid #007bff;
  max-height:480px;
  overflow-y:auto;
}
table {
  width:100%;
  border-collapse:collapse;
}
th, td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}
th {
  background:#007bff;
  color:white;
  position:sticky;
  top:0;
}
td:nth-child(2){ text-align:left; font-weight:bold; }

/* STATUS WARNA */
tr.hadir { background:#d4edda; animation:fadeIn .4s; }
tr.terlambat { background:#fff3cd; animation:shake .4s; }
tr.pulang { background:#d1ecf1; animation:fadeIn .4s; }
tr.belum { background:#f8d7da; opacity:.85; }

/* ANIMASI */
@keyframes fadeIn {
  from { opacity:0; transform:scale(.97); }
  to { opacity:1; transform:scale(1); }
}
@keyframes shake {
  0%{transform:translateX(0)}
  25%{transform:translateX(-4px)}
  50%{transform:translateX(4px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}

/* TOAST */
.toast {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:white;
  padding:10px 20px;
  border-radius:5px;
  z-index:9999;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <div>
    <h1>ABSENSI SISWA</h1>
    <h3>SMPN 20 Konawe Selatan</h3>
  </div>
</header>

<div id="container">
  <div>
    <div id="qr-reader"></div>
    <div id="filter-search">
      <select id="filter-kelas">
        <option value="">Semua Kelas</option>
      </select>
      <input type="text" id="search-input" placeholder="Cari NIS / Nama">
    </div>
  </div>

  <div id="absensi-wrapper">
    <table>
      <thead>
        <tr>
          <th>NIS</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Datang</th>
          <th>Pulang</th>
          <th>Status</th>
          <th>Keterangan</th>
        </tr>
      </thead>
      <tbody id="absensi-body"></tbody>
    </table>
  </div>
</div>

<!-- SOUND -->
<audio id="sound-datang" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="sound-pulang" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="sound-terlambat" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain:"absensi-smpn-20-konsel.firebaseapp.com",
  projectId:"absensi-smpn-20-konsel"
});
const db = firebase.firestore();

// VAR
const absensiBody = document.getElementById("absensi-body");
const filterKelas = document.getElementById("filter-kelas");
const searchInput = document.getElementById("search-input");
const soundDatang = document.getElementById("sound-datang");
const soundPulang = document.getElementById("sound-pulang");
const soundTerlambat = document.getElementById("sound-terlambat");

let dataAbsensi = [];
let debounce = {};

// SILENT MODE
const silentSchedule = [
  {start:"06:00", end:"06:30"},
  {start:"12:00", end:"12:15"}
];

function isSilent(){
  const now = new Date();
  const cur = now.getHours()*60+now.getMinutes();
  return silentSchedule.some(s=>{
    const [sh,sm]=s.start.split(":").map(Number);
    const [eh,em]=s.end.split(":").map(Number);
    return cur>=sh*60+sm && cur<=eh*60+em;
  });
}
function playSound(s){ if(!isSilent()) s.play(); }
function vibrate(){ navigator.vibrate && navigator.vibrate(150); }

// TOAST
function toast(msg){
  const t=document.createElement("div");
  t.className="toast";
  t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

// DATE
function today(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

// REALTIME TABLE
db.collection("absensi").doc(today()).onSnapshot(doc=>{
  const d = doc.data()||{};
  dataAbsensi = Object.values(d).sort((a,b)=>{
    const ta = a.jamPulang?.seconds || a.jamDatang?.seconds || 0;
    const tb = b.jamPulang?.seconds || b.jamDatang?.seconds || 0;
    return tb-ta;
  });
  render();
});

function render(){
  absensiBody.innerHTML="";
  dataAbsensi
  .filter(s=>{
    return (!filterKelas.value || s.kelas===filterKelas.value) &&
      (!searchInput.value ||
       s.nama.toLowerCase().includes(searchInput.value.toLowerCase()) ||
       s.nis.includes(searchInput.value));
  })
  .forEach(s=>{
    let cls="belum";
    if(s.keterangan==="Terlambat") cls="terlambat";
    else if(s.jamPulang) cls="pulang";
    else if(s.jamDatang) cls="hadir";

    const tr=document.createElement("tr");
    tr.className=cls;
    tr.innerHTML=`
      <td>${s.nis}</td>
      <td>${s.nama}</td>
      <td>${s.kelas}</td>
      <td>${s.jamDatang?new Date(s.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):'-'}</td>
      <td>${s.jamPulang?new Date(s.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):'-'}</td>
      <td>${s.status}</td>
      <td>${s.keterangan||'-'}</td>`;
    absensiBody.appendChild(tr);
  });
}

filterKelas.onchange=render;
searchInput.oninput=render;

// QR
new Html5Qrcode("qr-reader").start(
  {facingMode:"environment"},
  {fps:10,qrbox:300},
  nis=>{
    if(debounce[nis] && Date.now()-debounce[nis]<3000) return;
    debounce[nis]=Date.now();
    toast("Scan: "+nis);
    playSound(soundDatang);
    vibrate();
  }
);
</script>

</body>
</html>
