<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner Absensi Siswa</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#007bff;color:#fff;padding:14px;text-align:center}

/* LAYOUT */
#container{
  display:flex;
  gap:15px;
  padding:15px;
  flex-wrap:wrap;
  justify-content:center
}

/* QR */
#qr-box{width:100%;max-width:420px}
#qr-reader{
  width:100%;
  aspect-ratio:1/1;
  border:2px solid #007bff;
  border-radius:12px;
  background:#000
}

/* FILTER */
#filter-search{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap
}
#filter-search select,
#filter-search input{
  flex:1;
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px
}

/* PANEL */
#panel-control{
  margin-top:10px;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.15)
}
#panel-control label{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0
}

/* TABLE */
#absensi-wrapper{
  width:100%;
  max-width:900px;
  background:#fff;
  border-radius:10px;
  max-height:480px;
  overflow:auto;
  border:2px solid #007bff
}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;font-size:14px}
th{background:#007bff;color:#fff;position:sticky;top:0}
td:nth-child(2){font-weight:bold}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:10px 18px;
  border-radius:6px;
  z-index:9999
}
</style>
</head>

<body>

<header>
<h2>ABSENSI SISWA</h2>
SMPN 20 Konawe Selatan
</header>

<div id="container">

<!-- KIRI -->
<div id="qr-box">
  <div id="qr-reader"></div>

  <div id="filter-search">
    <select id="filter-kelas">
      <option value="">Semua Kelas</option>
    </select>
    <input id="search-input" placeholder="Cari NIS / Nama">
  </div>

  <div id="panel-control">
    <label><input type="checkbox" id="toggleSound" checked> ðŸ”Š Sound</label>
    <label><input type="checkbox" id="toggleVibrate" checked> ðŸ“³ Vibrasi</label>
  </div>
</div>

<!-- KANAN -->
<div id="absensi-wrapper">
<table>
<thead>
<tr>
<th>NIS</th><th>Nama</th><th>Kelas</th>
<th>Datang</th><th>Pulang</th><th>Status</th><th>Ket</th>
</tr>
</thead>
<tbody id="absensi-body"></tbody>
</table>
</div>

</div>

<audio id="sound-scan" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain:"absensi-smpn-20-konsel.firebaseapp.com",
  projectId:"absensi-smpn-20-konsel"
});
const db=firebase.firestore();

/* ELEMENT */
const bodyEl=document.getElementById("absensi-body");
const filterKelas=document.getElementById("filter-kelas");
const searchInput=document.getElementById("search-input");
const toggleSound=document.getElementById("toggleSound");
const toggleVibrate=document.getElementById("toggleVibrate");
const sound=document.getElementById("sound-scan");
sound.volume=0.4;

/* UTIL */
function toast(msg){
  const t=document.createElement("div");
  t.className="toast";
  t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}
function feedback(){
  if(toggleSound.checked){
    sound.currentTime=0; sound.play().catch(()=>{});
  }
  if(toggleVibrate.checked && navigator.vibrate){
    navigator.vibrate([120,80,120]);
  }
}

/* DATA */
let dataAbsensi=[];
function render(){
  const fk=filterKelas.value;
  const q=searchInput.value.toLowerCase();
  bodyEl.innerHTML="";
  dataAbsensi.filter(s=>
    (!fk||s.kelas===fk)&&
    (!q||s.nis.includes(q)||s.nama.toLowerCase().includes(q))
  ).forEach(s=>{
    bodyEl.innerHTML+=`
    <tr>
      <td>${s.nis}</td>
      <td>${s.nama}</td>
      <td>${s.kelas}</td>
      <td>${s.jamDatang||""}</td>
      <td>${s.jamPulang||""}</td>
      <td>${s.status}</td>
      <td>${s.keterangan}</td>
    </tr>`;
  });
}
filterKelas.onchange=render;
searchInput.oninput=render;

/* QR */
const qrSize=Math.min(window.innerWidth,360);
new Html5Qrcode("qr-reader").start(
  {facingMode:"environment"},
  {fps:10, qrbox:qrSize-40},
  text=>{
    feedback();
    toast("Scan: "+text);
  }
);
</script>
</body>
</html>
