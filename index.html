<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QR Scanner Absensi Siswa</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
header { background:#007bff; color:white; padding:15px; display:flex; gap:15px; align-items:center; justify-content:center; }
header img { width:80px; }

#container { display:flex; gap:20px; padding:20px; flex-wrap:wrap; justify-content:center; }
#qr-reader { width:400px; height:400px; border:3px solid #007bff; border-radius:10px; background:#000; }

#filter-search { margin-top:10px; display:flex; gap:10px; justify-content:center; }
#filter-search select,#filter-search input { padding:8px; border-radius:5px; }

#absensi-wrapper { flex:1; max-width:900px; background:white; border-radius:10px; overflow:auto; border:2px solid #007bff; }
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#007bff; color:white; position:sticky; top:0; }

/* ===== WARNA & ANIMASI ===== */
tr.hadir { background:#d4edda; animation: fadeIn .5s; }
tr.terlambat { background:#fff3cd; animation: shake .4s; }
tr.pulang { background:#d1ecf1; animation: fadeIn .5s; }
tr.tidak-hadir { background:#f8d7da; }

@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes shake {
  0%{transform:translateX(0)}
  25%{transform:translateX(-4px)}
  50%{transform:translateX(4px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}

.toast{
  position:fixed; bottom:20px; left:50%;
  transform:translateX(-50%);
  background:#333; color:white;
  padding:10px 20px; border-radius:5px;
}
</style>
</head>
<body>

<header>
  <img src="logo.png">
  <div>
    <h2>ABSENSI SISWA</h2>
    <small>SMPN 20 Konawe Selatan</small>
  </div>
</header>

<div id="container">
  <div>
    <div id="qr-reader"></div>
    <div id="filter-search">
      <select id="filter-kelas"><option value="">Semua Kelas</option></select>
      <input id="search-input" placeholder="Cari NIS / Nama">
    </div>
  </div>

  <div id="absensi-wrapper">
    <table>
      <thead>
        <tr>
          <th>NIS</th><th>Nama</th><th>Kelas</th>
          <th>Datang</th><th>Pulang</th><th>Status</th><th>Keterangan</th>
        </tr>
      </thead>
      <tbody id="absensi-body"></tbody>
    </table>
  </div>
</div>

<!-- ===== SOUND KHUSUS ===== -->
<audio id="sound-datang" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="sound-pulang" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="sound-terlambat" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain: "absensi-smpn-20-konsel.firebaseapp.com",
  projectId: "absensi-smpn-20-konsel"
});
const db = firebase.firestore();

// ================= AUDIO =================
const soundDatang = document.getElementById("sound-datang");
const soundPulang = document.getElementById("sound-pulang");
const soundTerlambat = document.getElementById("sound-terlambat");
[soundDatang,soundPulang,soundTerlambat].forEach(s=>s.volume=0.25);

function playSound(s){
  s.pause(); s.currentTime=0; s.play();
}

// ================= VIBRASI =================
function vibrateSuccess(){
  if(navigator.vibrate) navigator.vibrate([120,60,120]);
}

// ================= SILENT OTOMATIS =================
const silentSchedule = [
  {start:"06:00", end:"06:30"},
  {start:"12:00", end:"12:15"}
];
function isSilentTime(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  return silentSchedule.some(s=>{
    const [sh,sm]=s.start.split(":").map(Number);
    const [eh,em]=s.end.split(":").map(Number);
    return m>=sh*60+sm && m<=eh*60+em;
  });
}

// ================= UTIL =================
const absensiBody=document.getElementById("absensi-body");
const filterKelas=document.getElementById("filter-kelas");
const searchInput=document.getElementById("search-input");
let dataAbsensi=[];

function toast(msg){
  const t=document.createElement("div");
  t.className="toast"; t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

function today(){
  return new Date().toISOString().split("T")[0];
}

// ================= RENDER TABEL =================
function render(){
  absensiBody.innerHTML="";
  const fk=filterKelas.value;
  const s=searchInput.value.toLowerCase();

  dataAbsensi.filter(x=>{
    return (!fk||x.kelas===fk) &&
      (!s||x.nis.includes(s)||x.nama.toLowerCase().includes(s));
  }).forEach(x=>{
    let cls="";
    if(x.keterangan==="Terlambat") cls="terlambat";
    else if(x.keterangan==="Pulang") cls="pulang";
    else if(x.status==="Hadir") cls="hadir";
    else if(x.status==="TA") cls="tidak-hadir";

    const tr=document.createElement("tr");
    tr.className=cls;
    tr.innerHTML=`
      <td>${x.nis}</td>
      <td>${x.nama}</td>
      <td>${x.kelas}</td>
      <td>${x.jamDatang?new Date(x.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):""}</td>
      <td>${x.jamPulang?new Date(x.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):""}</td>
      <td>${x.status}</td>
      <td>${x.keterangan}</td>`;
    absensiBody.appendChild(tr);
  });
}

filterKelas.onchange=render;
searchInput.oninput=render;

// ================= LOGIKA ABSENSI =================
function updateAbsensi(nis){
  const now=new Date();
  const jam=now.getHours();

  const ref=db.collection("absensi").doc(today());
  ref.get().then(d=>{
    if(!d.exists || !d.data()[nis]){ toast("Data tidak ditemukan"); return; }
    const s=d.data()[nis];

    // DATANG
    if(!s.jamDatang){
      const terlambat = jam >= 7;
      ref.update({
        [`${nis}.jamDatang`]:firebase.firestore.FieldValue.serverTimestamp(),
        [`${nis}.status`]:"TK",
        [`${nis}.keterangan`]:terlambat?"Terlambat":"Hadir"
      }).then(()=>{
        toast(terlambat?"Datang TERLAMBAT":"Absen datang");
        if(!isSilentTime()){
          playSound(terlambat?soundTerlambat:soundDatang);
        }
        vibrateSuccess();
      });
    }

    // PULANG
    else if(!s.jamPulang){
      ref.update({
        [`${nis}.jamPulang`]:firebase.firestore.FieldValue.serverTimestamp(),
        [`${nis}.status`]:"Hadir",
        [`${nis}.keterangan`]:"Pulang"
      }).then(()=>{
        toast("Absen pulang");
        if(!isSilentTime()) playSound(soundPulang);
        vibrateSuccess();
      });
    }

    else toast("Sudah absen lengkap");
  });
}

// ================= QR =================
const qr=new Html5Qrcode("qr-reader");
qr.start({facingMode:"environment"},{fps:10,qrbox:250},
  msg=>updateAbsensi(msg.trim()),
  ()=>{}
);

// ================= REALTIME =================
db.collection("absensi").doc(today())
.onSnapshot(d=>{
  if(!d.exists) return;
  dataAbsensi=Object.values(d.data());
  render();
});
</script>
</body>
</html>
